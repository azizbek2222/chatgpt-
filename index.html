<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Telegram Kanal Tekshirish</title>
</head>
<body>
<h2>Telegram Kanal Tekshirish Mini App</h2>

<!-- Telegram Login Widget -->
<script async src="https://telegram.org/js/telegram-widget.js?22"
        data-telegram-login="Test2828vbot"
        data-size="large"
        data-on-auth="onTelegramAuth"
        data-request-access="write">
</script>

<!-- Tekshirish tugmasi -->
<div id="checkSection" style="display:none; margin-top:20px;">
  <button onclick="checkSubscription()">Kanalga obuna ekanligini tekshir</button>
  <p id="checkResult"></p>
</div>

<script>
let currentUser = null; // Foydalanuvchi ma'lumotlarini saqlash

// Telegram login chaqirilganda
function onTelegramAuth(user) {
  currentUser = user; // user.id, user.first_name, user.username va boshqalar
  alert('Logged in as ' + user.first_name + ' ' + (user.last_name || '') + ' (' + user.id + ')');
  
  // Tekshirish tugmasini ko‘rsatish
  document.getElementById('checkSection').style.display = 'block';
}

// Kanalga obuna tekshiruvchi funksiya
function checkSubscription() {
  if (!currentUser) {
    alert('Iltimos, avval Telegram orqali kiring!');
    return;
  }

  const BOT_TOKEN = '8224144427:AAEKcZywZtHP_61fLKLAWks0Pu9Q80aIDrg';
  const CHANNEL_USERNAME = '@rocket_mining_news'; // misol: mychannel

  fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getChatMember?chat_id=@${CHANNEL_USERNAME}&user_id=${currentUser.id}`)
    .then(response => response.json())
    .then(data => {
      if(data.ok) {
        const status = data.result.status;
        if(status === 'creator' || status === 'administrator' || status === 'member') {
          document.getElementById('checkResult').innerText = 'Siz kanalga obuna bo‘lgansiz ✅';
        } else {
          document.getElementById('checkResult').innerText = 'Siz kanalga obuna emassiz ❌';
        }
      } else {
        document.getElementById('checkResult').innerText = 'Xatolik: ' + data.description;
      }
    })
    .catch(err => {
      document.getElementById('checkResult').innerText = 'Xatolik: ' + err;
    });
}
</script>
</body>
</html>